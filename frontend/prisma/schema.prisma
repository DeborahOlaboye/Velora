// Prisma schema for Velora
// Mutual Aid for the Modern Worker
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Worker/User model
model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Identity Verification (Self Protocol)
  isSelfVerified Boolean   @default(false)
  selfVerifiedAt DateTime?
  selfUserId     String?

  // Worker Information
  gigWorkType     String?
  location        String?
  yearsExperience Int?
  monthlyIncome   Decimal? @db.Decimal(10, 2)

  // Profile
  email           String?
  phoneNumber     String?
  profilePhotoUrl String?

  // Pool Participation
  isRegistered        Boolean   @default(false)
  registeredAt        DateTime?
  monthlyContribution Decimal?  @db.Decimal(10, 2)

  // Status
  isActive        Boolean @default(true)
  isSuspended     Boolean @default(false)
  suspendedReason String?

  // Engagement Rewards & Referrals
  invitedBy                   String? // Wallet address of inviter
  inviter                     User?   @relation("UserInvites", fields: [invitedBy], references: [walletAddress], onDelete: SetNull)
  invitedUsers                User[]  @relation("UserInvites")
  hasClaimedEngagementReward  Boolean @default(false)
  engagementRewardClaimedAt   DateTime?
  engagementRewardTxHash      String?
  totalInvites                Int     @default(0)
  successfulInvites           Int     @default(0)

  // Relationships
  contributions      Contribution[]
  withdrawalRequests WithdrawalRequest[]
  votes              Vote[]
  notifications      Notification[]
  activityLogs       ActivityLog[]
  engagementRewards  EngagementReward[]

  @@index([walletAddress])
  @@index([isSelfVerified])
  @@index([isRegistered])
  @@index([createdAt])
  @@index([invitedBy])
}

// Contribution tracking
model Contribution {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("cUSD")

  // Transaction details
  txHash      String   @unique
  blockNumber Int
  timestamp   DateTime @default(now())

  // Metadata
  contributionType String @default("MONTHLY") // MONTHLY, ONE_TIME, GOODDOLLAR
  status           String @default("CONFIRMED") // PENDING, CONFIRMED, FAILED

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@index([status])
  @@index([txHash])
}

// Emergency withdrawal requests
model WithdrawalRequest {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Request details
  amount         Decimal  @db.Decimal(10, 2)
  reason         String
  urgencyLevel   String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  supportingDocs String[] // URLs to IPFS

  // Smart contract data
  requestId Int     @unique // From smart contract
  txHash    String? // Transaction hash for request

  // Status
  status String @default("PENDING") // PENDING, VOTING, APPROVED, REJECTED, EXECUTED

  // Voting
  votesFor       Int      @default(0)
  votesAgainst   Int      @default(0)
  votingDeadline DateTime

  // Execution
  executedAt      DateTime?
  executionTxHash String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  votes Vote[]

  @@index([userId])
  @@index([status])
  @@index([requestId])
  @@index([votingDeadline])
  @@index([createdAt])
}

// Voting on withdrawal requests
model Vote {
  id String @id @default(cuid())

  requestId String
  request   WithdrawalRequest @relation(fields: [requestId], references: [id])

  voterId String
  voter   User   @relation(fields: [voterId], references: [id])

  // Vote details
  support Boolean // true = approve, false = deny
  comment String?

  // Transaction
  txHash String?

  // Timestamp
  votedAt DateTime @default(now())

  @@unique([requestId, voterId])
  @@index([requestId])
  @@index([voterId])
  @@index([votedAt])
}

// Notifications for users
model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Notification details
  type    String // CONTRIBUTION_REMINDER, VOTING_REQUEST, WITHDRAWAL_STATUS, etc.
  title   String
  message String

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Metadata
  metadata Json? // Additional data

  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}

// Activity logs for auditing
model ActivityLog {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Activity details
  action     String // REGISTER, CONTRIBUTE, REQUEST_WITHDRAWAL, VOTE, etc.
  entityType String? // User, Contribution, WithdrawalRequest, Vote
  entityId   String?

  // Context
  metadata  Json?
  ipAddress String?
  userAgent String?

  // Timestamp
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
}

// Pool statistics (aggregated data)
model PoolStats {
  id String @id @default(cuid())

  // Pool metrics
  totalBalance       Decimal @db.Decimal(18, 2)
  totalContributions Decimal @db.Decimal(18, 2)
  totalWithdrawals   Decimal @db.Decimal(18, 2)

  activeWorkers Int
  totalWorkers  Int

  // Withdrawal metrics
  pendingRequests  Int
  approvedRequests Int
  rejectedRequests Int

  // Snapshot
  snapshotDate DateTime @default(now())

  @@index([snapshotDate])
}

// Sync status for blockchain events
model SyncStatus {
  id String @id @default(cuid())

  contractAddress String
  eventType       String // WorkerRegistered, ContributionMade, WithdrawalRequested, etc.

  lastSyncedBlock Int
  lastSyncedAt    DateTime @default(now())

  status       String  @default("ACTIVE") // ACTIVE, PAUSED, ERROR
  errorMessage String?

  @@unique([contractAddress, eventType])
  @@index([contractAddress])
  @@index([lastSyncedAt])
}

// Engagement rewards tracking
model EngagementReward {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Reward details
  rewardType    String  // REGISTRATION, CONTRIBUTION, MILESTONE, etc.
  amount        Decimal @db.Decimal(18, 6)
  currency      String  @default("G$")

  // Inviter information
  inviterUserId String?
  inviterAddress String?

  // Blockchain transaction
  txHash      String?
  blockNumber Int?
  status      String   @default("PENDING") // PENDING, CLAIMED, FAILED

  // Metadata
  metadata Json? // Additional data about the reward

  // Timestamps
  claimedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@index([rewardType])
  @@index([createdAt])
  @@index([inviterUserId])
}
